# ギルド加入申請システム実装ガイド

## 概要
ETKWギルド用の自作申請システムが実装されました。既存のTicket Toolを置き換える完全自動化されたシステムです。

## 実装内容

### 1. データベース構造
- `applications` テーブルを新規追加
- MCID、Discord ID、理由、過去ギルド、チャンネルID、作成日時を保存

### 2. 申請フロー
1. **申請ボタン**: 申請チャンネルに常時表示される永続ボタン
2. **申請フォーム**: MCID（必須）、理由（必須）、過去ギルド（任意）を入力
3. **チャンネル作成**: 申請者専用の個別チャンネルを自動生成
4. **Embed送信**: 4つのEmbedを自動送信
   - ① ご案内Embed（既存の関数を流用）
   - ② MCIDプロファイル情報（API取得、スキン画像付き）
   - ③ 加入理由
   - ④ 過去ギルド情報（API取得・自動補正）

### 3. 加入検知・自動処理
- 3分ごとにギルドメンバーをAPI監視
- 申請者の加入を検知すると以下を自動実行：
  - ランクロール・ETKWロール付与
  - ニックネーム設定（[ランク] MCID形式）
  - 申請チャンネル削除
  - トランスクリプトをログチャンネルに送信
  - DB申請情報削除

### 4. 管理機能
- **定期復旧**: 30分ごとに申請Embedの存在確認・自動復旧
- **永続View**: Bot再起動後も申請ボタンが機能継続
- **エラーハンドリング**: 各段階での例外処理とログ出力

## 設定方法

### 環境変数設定
以下の環境変数を追加してください：

```bash
APPLICATION_CHANNEL_ID=申請チャンネルのID
APPLICATION_LOG_CHANNEL_ID=トランスクリプト送信先チャンネルのID
```

### 初回セットアップ
1. Botを起動（データベーステーブルが自動作成されます）
2. 申請チャンネルで `/send_application_embed` コマンド実行（手動実装推奨）
3. 申請ボタンが正常に表示されることを確認

## ファイル構成

### 新規ファイル
- `lib/application_views.py`: 申請ボタンView・申請フォームModal・Embed生成

### 更新ファイル
- `lib/db.py`: 申請テーブル・関連DB関数追加
- `lib/ticket_embeds.py`: トランスクリプトEmbed関数追加
- `main.py`: 永続View登録・定期復旧タスク追加
- `tasks/member_sync_tasks.py`: 加入検知・自動処理タスク追加

## 使用方法

### 利用者側
1. 申請チャンネルの「🎮 ギルド加入申請」ボタンをクリック
2. フォームにMCID、理由、過去ギルドを入力して送信
3. 専用チャンネルが作成され、詳細情報が表示される
4. スタッフの確認とゲーム内招待を待機
5. ギルド加入後、自動的にロール付与・チャンネル削除

### スタッフ側
- 申請チャンネルで申請内容を確認
- ゲーム内で該当プレイヤーを招待
- システムが自動的に加入検知・処理を実行

## 技術仕様

### API連携
- WynncraftAPI: プレイヤー情報・ギルド情報取得
- OtherAPI: プレイヤースキン画像取得

### ロール管理
- 自動ランクロール付与（config.py RANK_ROLE_ID_MAP使用）
- ETKWロール付与
- 管理者権限ユーザーはニックネーム変更対象外

### エラー処理
- API取得失敗時の代替表示
- チャンネル作成失敗時のロールバック
- 各段階での詳細ログ出力

## 監視ポイント

### ログ確認項目
- `[ApplicationSync]`: 加入検知・自動処理ログ
- `申請システム`: View登録・Embed復旧ログ
- `申請処理中にエラー`: フォーム送信時のエラー

### 定期チェック
- 申請チャンネルにボタンが存在するか
- 申請者の加入が正常に検知されているか
- ロール付与・ニックネーム設定が正常か

## トラブルシューティング

### よくある問題
1. **申請ボタンが反応しない**: Bot再起動で永続View再登録
2. **API取得エラー**: Wynncraft API状況確認
3. **ロール付与失敗**: Bot権限・ロール階層確認
4. **チャンネル削除失敗**: Bot権限確認

### 手動復旧方法
```python
# 申請Embed手動送信
from lib.application_views import send_application_embed
await send_application_embed(channel)

# 申請完了手動処理
from lib.db import remove_application
remove_application(discord_id)
```

このシステムにより、既存の運用を完全に置き換える自動化された申請システムが完成しました。